{% extends "base.html" %}
{% load static %}

{% block extra_head %}
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Font Awesome –¥–ª—è –∏–∫–æ–Ω–æ–∫ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π CSS -->
    <link rel="stylesheet" href="{% static 'css/main_screen.css' %}">
    <link rel="stylesheet" href="{% static 'css/fonts.css' %}">
{% endblock %}

{% block content %}



<div class="container mt-5">
    <!-- –ö–∞—Ä—É—Å–µ–ª—å -->
    <div id="mainCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
            <!-- –°–ª–∞–π–¥ 1 -->
            <div class="carousel-item active" data-bs-interval="2000">
              <img src="{% static 'img/main1.jpg' %}" class="d-block w-100" alt="Slide 1" width="100%" height="500">
              <div class="carousel-caption" style="left: 50%; transform: translateX(-50%); text-align: center;">
                  <h1 class="Skartvelo">Skartvelo</h1>
                  <hr>
                  <h5>–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ!</h5>
                  <p>–ù–∞—Å–æ–ª–æ–¥–∂—É–π—Ç–µ—Å—å –Ω–∞—à–∏–º–∏ –Ω–∞–π–∫—Ä–∞—â–∏–º–∏ —Å—Ç—Ä–∞–≤–∞–º–∏.</p>
                  <a href="{% url 'list-dish' %}" class="btn btn-light btn-hover-dark">–ø–µ—Ä–µ–π—Ç–∏ –¥–æ —Å—Ç—Ä–∞–≤</a>
              </div>
          </div>
          
            <!-- –°–ª–∞–π–¥ 2 -->
            <div class="carousel-item" data-bs-interval="2000">
                <img src="{% static 'img/main2.jpg' %}" class="d-block w-100" alt="Slide 2" width="100%" height="500">
                <div class="carousel-caption" style="left: 50%; transform: translateX(-50%); text-align: center;">
                    <h1 class="Skartvelo">Skartvelo</h1>
                    <hr>
                    <h3>–ì–∞—Ä–Ω—ñ –∫—Ä–∞—î–≤–∏–¥–∏</h3>
                    <p>–ü–æ–≥–ª—è–Ω—å—Ç–µ –Ω–∞ –Ω–∏—Ö –ø—Ä—è–º–æ –∑–∞—Ä–∞–∑</p>
                    <a href="{% url 'gallery' %}" class="btn btn-light btn-hover-dark">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –≥–∞–ª–µ—Ä–µ—ó</a>
                </div>
            </div>
            <!-- –°–ª–∞–π–¥ 3 -->
            <div class="carousel-item" data-bs-interval="2000">
                <img src="{% static 'img/main3.jpg' %}" class="d-block w-100" alt="Slide 3" width="100%" height="500">
                <div class="carousel-caption" style="left: 50%; transform: translateX(-50%); text-align: center;">
                    <h1 class="Skartvelo">Skartvelo</h1>
                    <hr>
                    <h3>–Ø–∫—ñ—Å–Ω–∏–π —Å–µ—Ä–≤—ñ—Å</h3>
                    <p>–ú–∏ –¥–±–∞—î–º–æ –ø—Ä–æ –≤–∞—à –∫–æ–º—Ñ–æ—Ä—Ç.</p>
                    <a href="{% url 'booking' %}" class="btn btn-light btn-hover-dark">–ó–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏ —Å—Ç–æ–ª–∏–∫</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –í—ã–≤–æ–¥ –∑–≤–µ–∑–¥ -->
    <div class="small-ratings-container d-flex align-items-center flex-wrap gap-3">
        {% if avg_dish_rating %}
            <div class="small-rating-block d-flex align-items-center gap-2">
                <p class="small-rating-title m-0">—Å—Ç—Ä–∞–≤–∏:</p>
                <div class="small-star-rating d-flex align-items-center">
                    {% for i in stars %}
                        <i class="fas fa-star {% if i <= avg_dish_rating %}text-warning{% else %}text-muted{% endif %}"></i>
                    {% endfor %}
                    <span class="small-rating-value">({{ avg_dish_rating }})</span>
                </div>
            </div>
        {% endif %}
    
        {% if avg_service_rating %}
            <div class="small-rating-block d-flex align-items-center gap-2">
                <p class="small-rating-title m-0">—Å–µ—Ä–≤—ñ—Å:</p>
                <div class="small-star-rating d-flex align-items-center">
                    {% for i in stars %}
                        <i class="fas fa-star {% if i <= avg_service_rating %}text-warning{% else %}text-muted{% endif %}"></i>
                    {% endfor %}
                    <span class="small-rating-value">({{ avg_service_rating }})</span>
                </div>
            </div>
        {% endif %}
    </div>


    <div class="text-center p-4 mt-5 bg-light border rounded">
        <h2 class="text-danger">–ù–æ–≤–∏–Ω–∫–∞!</h2>
        <p>–°–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞—à—É –Ω–æ–≤—É —Å—Ç—Ä–∞–≤—É ‚Äì —Å–ø—Ä–∞–≤–∂–Ω—é –≥–∞—Å—Ç—Ä–æ–Ω–æ–º—ñ—á–Ω—É –Ω–∞—Å–æ–ª–æ–¥—É! –ù–µ –ø—Ä–æ–ø—É—Å—Ç—ñ—Ç—å —à–∞–Ω—Å –Ω–∞—Å–æ–ª–æ–¥–∏—Ç–∏—Å—è –≤–∏—à—É–∫–∞–Ω–∏–º–∏ —Å–º–∞–∫–∞–º–∏.</p>
    </div>

    <hr>
    
    <div class="row featurette">
        <div class="col-md-7">
          <h2 class="featurette-heading">–•–ª—ç–±. <span class="text-muted">–û—Å–æ–±–ª–∏–≤–∏–π.</span></h2>
          <p class="lead">—Å–∫–æ—à—Ç—É–π—Ç–µ –Ω–æ–≤–∏–Ω—É —Ä–æ–∫—É!.</p>
        </div>
        <div class="col-md-5">
          <img src="{% static 'img/95.jpg' %}" class="img-fluid featurette-image mx-auto" alt="–ú–æ—ë –±–ª—é–¥–æ" width="500" height="500">
        </div>
      </div>

    <hr>

    <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (<span id="comments-count">{{ total_comments }}</span>)</h3>
 

    <div id="comments-container">
      {% for comment in comments|slice:":3" %}
      <div class="border p-2 mb-2 comment-item">
          <p><b>{{ comment.user.username }}</b></p>
          <p>–û—Ü–µ–Ω–∫–∞ –∑–∞ –±–ª—é–¥–∞: ‚≠ê {{ comment.dish_rating }}/5</p>
          <p>–û—Ü–µ–Ω–∫–∞ –∑–∞ —Å–µ—Ä–≤–∏—Å: ‚≠ê {{ comment.service_rating }}/5</p>
          <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {{ comment.comment }}</p>
          <p><small>–î–∞—Ç–∞: {{ comment.created_at|date:"d.m.Y H:i" }}</small></p>
  
          {% if request.user.is_staff %}
          <button 
              class="btn btn-danger btn-sm delete-comment-btn" 
              data-comment-id="{{ comment.id }}"
          >
              üóë
          </button>
          {% endif %}
      </div>
      {% endfor %}
    </div>
    
    
  
  
  <button id="load-more-btn" class="btn btn-primary" onclick="loadMoreComments()">–ø–æ–∫–∞–∑–∞—Ç–∏ —â–µ</button>
    
    
</div>

<script>
  const isStaff = {{ is_staff|yesno:"true,false" }}; // –ü–µ—Ä–µ–¥–∞–µ–º —Å—Ç–∞—Ç—É—Å staff –≤ JavaScript
</script>

<script>
  let totalComments = {{ total_comments|default:0 }};
</script>


<script>
  function getStars(rating) {
    return "‚≠ê".repeat(rating);
  }

  
  let offset = 0;
  function loadMoreComments() {
    fetch(`/mark/load_comments/?offset=${offset}`)
        .then(response => response.json())
        .then(data => {
            if (data.comments.length > 0) {
                const container = document.getElementById("comments-container");
                data.comments.forEach(comment => {
                    const div = document.createElement("div");
                    div.classList.add(
                      "border", "p-3", "mb-3", "comment-item", 
                      "rounded", "shadow-sm", "bg-light"
                    );

                    // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                    let commentHTML = `
                        <h4><b>${comment.user}</b></h4>
                        <p>–û—Ü–µ–Ω–∫–∞ –∑–∞ –±–ª—é–¥–∞: ${'‚≠ê'.repeat(comment.dish_rating)}</p>
                        <p>–û—Ü–µ–Ω–∫–∞ –∑–∞ —Å–µ—Ä–≤–∏—Å: ${'‚≠ê'.repeat(comment.service_rating)}</p>
                        <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment.comment}</p>
                        <p>–î–∞—Ç–∞: ${comment.created_at}</p>
                    `;

                    if (comment.is_staff) {
                      commentHTML += `
                          <button 
                              class="btn btn-danger btn-sm delete-comment-btn" 
                              data-comment-id="${comment.id}"
                          >
                              üóë
                          </button>
                      `;
                  }

                    div.innerHTML = commentHTML;
                    container.appendChild(div);
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
                attachDeleteButtonHandlers();

                offset += data.comments.length;
            }
            
            if (data.total_count !== undefined) {
              updateCommentsCount(data.total_count);
            }

            if (!data.has_more) {
                document.getElementById("load-more-btn").style.display = "none";
            }
        });
  }

  function updateCommentsCount(count) {
    document.getElementById("comments-count").textContent = count;
  }
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = function () {
      loadMoreComments();
  };
  
</script>



<script>
  function updateCommentsCount() {
    let countElement = document.getElementById("comments-count");
    let commentsContainer = document.getElementById("comments-container");
    countElement.textContent = commentsContainer.children.length;
  }
</script>

<script>
  function getCSRFToken() {
      const csrftoken = document.cookie.split("; ")
          .find(row => row.startsWith("csrftoken="))
          ?.split("=")[1];
      return csrftoken || "";
  }
</script>

<script>
  function attachDeleteButtonHandlers() {
      document.querySelectorAll(".delete-comment-btn").forEach(button => {
          button.addEventListener("click", () => {
              const commentId = button.getAttribute("data-comment-id");
              deleteComment(commentId);
          });
      });
  }
</script>

<script>
  function deleteComment(commentId) {
      fetch(`/mark/delete_comment/${commentId}/`, {
          method: "POST",
          headers: {
              "X-CSRFToken": getCSRFToken(),  // –í–∫–ª—é—á–∞–µ—Ç CSRF-—Ç–æ–∫–µ–Ω –≤ –∑–∞–ø—Ä–æ—Å
          },
      })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  // –£–¥–∞–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∏–∑ DOM
                  const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`).closest(".comment-item");
                  if (commentElement) {
                      commentElement.remove();
                  }
              } else {
                  alert("–û—à–∏–±–∫–∞: " + data.error);
              }
          })
          .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:", error));
  }
</script>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}